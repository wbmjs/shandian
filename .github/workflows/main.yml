name: ğŸ”„ Auto Update Clash Config

on:
  schedule:
    - cron: '0 0 * * *'  # UTC 0:00 = åŒ—äº¬æ—¶é—´ 8:00
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ›ï¸ Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸŒ Fetch Clash config from Railway
        run: |
          echo "â¡ï¸ Fetching config from Railway..."
          # ä½¿ç”¨ -f ä¼šå›  500 æŠ¥é”™é€€å‡ºï¼Œä½†æˆ‘ä»¬æ˜¾å¼å¤„ç†
          if ! curl -f -s -o clash_auto.yaml "https://your-project.up.railway.app/clash"; then
            echo "âŒ Failed to fetch config (HTTP error or empty response)"
            exit 1
          fi

          # æ£€æŸ¥æ˜¯å¦æ˜¯æœ‰æ•ˆ YAMLï¼ˆè‡³å°‘åŒ…å« proxiesï¼‰
          if ! grep -q "proxies:" clash_auto.yaml; then
            echo "âŒ Invalid config: not a valid Clash YAML"
            cat clash_auto.yaml  # æ‰“å°ä¾¿äºè°ƒè¯•
            exit 1
          fi

          echo "âœ… Valid Clash config received"

      - name: ğŸ“¤ Commit and push
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add clash_auto.yaml
          git commit -m "ğŸ”„ Auto-update Clash config [$(date -u)]" || echo "â„¹ï¸ No changes to commit"
          git push
